#!/bin/sh

################################################################################
# Version 1.4.0-RELEASE (16-01-2022)
################################################################################

################################################################################
# Copyright 2019-2022 Nozel/Sebas Veeke. Licenced under a Creative Commons
# Attribution-NonCommercial-ShareAlike 4.0 International License.
#
# See https://creativecommons.org/licenses/by-nc-sa/4.0/
#
# Contact:
# > e-mail      mail@nozel.org
# > GitHub      onnozel
################################################################################

################################################################################
# VARIABLES
################################################################################

# serverbot version
BACKUPBOT_VERSION='1.4.0'

# backupbot parameters can be configured in /usr/local/etc/backupbot.conf
# if the backupbot configuration file exists, it gets sourced by backupbot
if [ -f /usr/local/etc/backupbot.conf ]; then
    # populate all usable variables to check validity later on
    AUTOMATIC_BACKUP_ENABLE='0'
    AUTOMATIC_BACKUP_DAILY='0'
    AUTOMATIC_BACKUP_WEEKLY='0'
    BACKUP_ENCRYPTION_ENABLE='0'
    BACKUP_ENCRYPTION_SECRET='0'
    BACKUP_FILES_ENABLE='0'
    BACKUP_FILES_PREFIX='0'
    BACKUP_FILES_RETENTION_DAILY='0'
    BACKUP_FILES_RETENTION_WEEKLY='0'
    BACKUP_FILES_COMPRESSION='0'
    BACKUP_FILES_DESTINATION='0'
    BACKUP_FILES='0'
    BACKUP_MYSQL_ENABLE='0'
    BACKUP_MYSQL_PREFIX='0'
    BACKUP_MYSQL_RETENTION_DAILY='0'
    BACKUP_MYSQL_RETENTION_WEEKLY='0'
    BACKUP_MYSQL_COMPRESSION='0'
    BACKUP_MYSQL_DESTINATION='0'
    ARGUMENT_VERSION='0'
    ARGUMENT_HELP='0'
    ARGUMENT_CRON='0'
    ARGUMENT_BACKUP='0'
    ARGUMENT_FILES='0'
    ARGUMENT_MYSQL='0'
    ARGUMENT_DAILY='0'
    ARGUMENT_WEEKLY='0'
    ARGUMENT_NONE='0'

    # and source backupbot.conf
    . /usr/local/etc/backupbot.conf

    # and finally use default values for unconfigured parameters
    if [ "${BACKUP_FILES_PREFIX}" = '0' ]; then
        BACKUP_FILES_PREFIX="$(date +%y%m%dT%H%M)"
    fi
    if [ "${BACKUP_MYSQL_PREFIX}" = '0' ]; then
        BACKUP_MYSQL_PREFIX="$(date +%y%m%dT%H%M)"
    fi
else
    # if backupbot.conf does not exist, return this error 
    echo 'backupbot: error: /usr/local/etc/backupbot.conf is required but cannot be found'
    exit 1
fi

################################################################################
# ARGUMENTS
################################################################################

# enable arguments to backupbot
while test -n "$1"; do
    case "$1" in
        # options
        --version)
            ARGUMENT_VERSION='1'
            shift
            ;;

        --help|-help|help|--h|-h)
            ARGUMENT_HELP='1'
            shift
            ;;

        --cron)
            ARGUMENT_CRON='1'
            shift
            ;;

        # features
        --backup|backup|-b)
            ARGUMENT_BACKUP='1'
            shift
            ;;

        --files|files|-f)
            ARGUMENT_FILES='1'
            shift
            ;;

        --mysql|mysql|-m)
            ARGUMENT_MYSQL='1'
            shift
            ;;

        # other
        --daily)
            ARGUMENT_DAILY='1'
            shift
            ;;

        --weekly)
            ARGUMENT_WEEKLY='1'
            shift
            ;;
        *)
            ARGUMENT_NONE='1'
            shift
            ;;
    esac
done

################################################################################
# ERROR FUNCTIONS
################################################################################

# requirement errors
error_invalid_argument() {
    echo 'backupbot: error: used argument is invalid, use "backuptbot --help" for proper usage'
    exit 1
}    

error_no_root_privileges() {
    echo 'backupbot: error: used argument must be run with root privileges'
    exit 1
}

error_os_not_supported() {
    echo 'backupbot: operating system is not supported'
    exit 1
}

# configuration errors
error_destination_not_configured() {
    echo 'backupbot: error: backup destination is not configured properly in /usr/local/etc/backupbot.conf'
    exit 1
}

error_source_not_configured() {
    echo 'backupbot: error: backup source is not configured properly in /usr/local/etc/backupbot.conf'
    exit 1
}

error_cron_not_configured() {
    echo 'backupbot: error: cron is not configured properly in /usr/local/etc/backupbot.conf'
    exit 1
}

error_no_feature_configured() {
    echo 'backupbot: error: no backup feature is enabled in /usr/local/etc/backupbot.conf'
    exit 1
}

error_retention_not_integer() {
    echo 'backupbot: error: retention should be a positive number in /usr/local/etc/backupbot.conf'
    exit 1
}

error_feature_not_configured() {
    echo 'backupbot: error: one of the invoked features is not configured in /usr/local/etc/backupbot.conf'
    exit 1
}

error_gpg_not_installed() {
    echo 'backupbot: error: gpg is required but not installed'
    echo 'backupbot: install gpg with "pkg install gnupg"'
    exit 1
}

error_compression_not_configured() {
    echo 'backupbot: error: compression is not configured properly in /usr/local/etc/backupbot.conf'
    exit 1
}

error_daily_backup_not_configured() {
    echo 'backupbot: error: AUTOMATIC_BACKUP_DAILY is not configured properly in /usr/local/etc/backupbot.conf'
    exit 1
}

################################################################################
# REQUIREMENT FUNCTIONS
################################################################################

requirement_argument_validity() {
    # enabled backup features must have file destinations
    if [ "${BACKUP_FILES_ENABLE}" = 'YES' ] && [ "${BACKUP_FILES_DESTINATION}" = '0' ]; then
        error_destination_not_configured
    fi
    if [ "${BACKUP_MYSQL_ENABLE}" = 'YES' ] && [ "${BACKUP_MYSQL_DESTINATION}" = '0' ]; then
        error_destination_not_configured
    fi
    # enabled backup features must have configured file sources
    if [ "${BACKUP_FILES_ENABLE}" = 'YES' ] && [ "${BACKUP_FILES}" = '0' ]; then
        error_source_not_configured
    fi
    # at least one backup feature must be enabled
    if [ "${BACKUP_FILES_ENABLE}" = '0' ] && [ "${BACKUP_MYSQL_ENABLE}" = '0' ]; then
        error_no_feature_configured
    fi
    # backup feature retention must be a integer
    if ! [ "${BACKUP_FILES_RETENTION_DAILY}" -eq "${BACKUP_FILES_RETENTION_DAILY}" ] 2> /dev/null; then
        error_retention_not_integer
    fi
    if ! [ "${BACKUP_FILES_RETENTION_WEEKLY}" -eq "${BACKUP_FILES_RETENTION_WEEKLY}" ] 2> /dev/null; then
        error_retention_not_integer
    fi
    if ! [ "${BACKUP_MYSQL_RETENTION_DAILY}" -eq "${BACKUP_MYSQL_RETENTION_DAILY}" ] 2> /dev/null; then
        error_retention_not_integer
    fi
    if ! [ "${BACKUP_MYSQL_RETENTION_WEEKLY}" -eq "${BACKUP_MYSQL_RETENTION_WEEKLY}" ] 2> /dev/null; then
        error_retention_not_integer
    fi
    # compression feature number must be 0, 2, 3 or 4
    if [ "${BACKUP_FILES_COMPRESSION}" != '0' ] && [ "${BACKUP_FILES_COMPRESSION}" != '1' ] && [ "${BACKUP_FILES_COMPRESSION}" != '2' ] && [ "${BACKUP_FILES_COMPRESSION}" != '3' ]; then
        error_compression_not_configured
    fi
    # daily backup needs to be configured for automatic backup to work
    if [ "${AUTOMATIC_BACKUP_ENABLE}" = 'YES' ] && [ "${AUTOMATIC_BACKUP_DAILY}" = '0' ]; then
        error_daily_backup_not_configured
    fi
    # weekly and daily backups can't be used at the same time
    if [ "${ARGUMENT_DAILY}" = '1' ] && [ "${ARGUMENT_WEEKLY}" = '1' ]; then
        error_invalid_argument
    fi
}

requirement_root() {
    # show error when backupbot isn't run with root privileges
    if [ "$(id -u)" -ne '0' ]; then
        error_no_root_privileges
    fi
}

requirement_os() {
    # show error when freebsd-version cannot be found
    if [ ! "$(command -v freebsd-version)" ]; then
        error_os_not_supported
    fi
}

requirement_gpg() {
    # show error when gpg cannot be found
    if [ ! "$(command -v gpg)" ]; then
        error_gpg_not_installed
    fi
}

requirement_prevent_backup_overlap() {
    # weekly and daily backup schedules will overlap for one day a week, this will prevent that from happening
    if [ "${AUTOMATIC_BACKUP_ENABLE}" = 'YES' ]; then
        if [ "${AUTOMATIC_BACKUP_DAILY}" -ge 0 ] && [ "${AUTOMATIC_BACKUP_DAILY}" -le 23 ]; then
            if [ "${AUTOMATIC_BACKUP_WEEKLY}" -ge 1 ] && [ "${AUTOMATIC_BACKUP_WEEKLY}" -le 7 ]; then
                if [ "${AUTOMATIC_BACKUP_WEEKLY}" -eq "$(date '+%u')" ]; then
                    if [ "${ARGUMENT_DAILY}" = '1' ]; then
                        exit 0
                    fi
                fi
            fi
        fi
    fi
}

################################################################################
# GENERAL FUNCTIONS
################################################################################

option_version() {
    echo "backupbot version ${BACKUPBOT_VERSION}"
    echo "Copyright (C) 2019-2022 Nozel."
    echo "License CC Attribution-NonCommercial-ShareAlike 4.0 Int."
    echo
    echo "Written by Sebas Veeke"
}

option_help() {
    echo "Usage:"
    echo " backupbot [feature/option]..."
    echo
    echo "Features:"
    echo " -b, --backup         Backup everything configured in configuration file"
    echo " -f, --files          Backup files configured in configuration file"
    echo " -m, --mysql          Backup MySQL databases configured in configuration file"
    echo
    echo "Options:"
    echo " --cron               Effectuate cron changes from serverbot config"
    echo " --help               Display this help and exit"
    echo " --version            Display version information and exit"
}

option_cron() {
    echo '[1] Removing old backupbot cronjob'
    rm -f /etc/cron.d/backupbot
    if [ "${AUTOMATIC_BACKUP_ENABLE}" = 'YES' ]; then
        if [ "${AUTOMATIC_BACKUP_DAILY}" -ge 0 ] && [ "${AUTOMATIC_BACKUP_DAILY}" -le 23 ]; then
        echo "[2] Adding daily scheduled backup on ${AUTOMATIC_BACKUP_DAILY}:00"
        echo '# This cronjob activates backupbot daily on the chosen schedule' > /etc/cron.d/backupbot
        echo "0 ${AUTOMATIC_BACKUP_DAILY} * * * root /usr/bin/backupbot --backup --daily" >> /etc/cron.d/backupbot
        fi
        if [ "${AUTOMATIC_BACKUP_WEEKLY}" -ge 1 ] && [ "${AUTOMATIC_BACKUP_WEEKLY}" -le 7 ]; then
        echo "[3] Adding weekly scheduled backup on day ${AUTOMATIC_BACKUP_WEEKLY}"
        echo '' >> /etc/cron.d/backupbot
        echo '# This cronjob activates backupbot weekly on the chosen schedule' >> /etc/cron.d/backupbot
        echo "0 ${AUTOMATIC_BACKUP_DAILY} * * ${AUTOMATIC_BACKUP_WEEKLY} root /usr/bin/backupbot --backup --weekly" >> /etc/cron.d/backupbot
        fi
        echo
        echo 'All done! Your new schedule can be found in /etc/cron.d/backupbot'
    else
        echo 'Automatic backup is disabled, skipping creation of cronjob'
    fi
}

################################################################################
# FEATURE FUNCTIONS
################################################################################

# the following settings are used for tar:
# --create               (-c) create new archive containing the specified items
# --preserve-permissions (-p) preserve file permissions
# --gzip                 (-z) compress the resulting archive with gunzip
# --bzip2                (-j) compress the resulting archive with bzip2
# --xz                   (-J) compress the resulting archive with xz
# --file -               (-f) pipe the archive to next command
# --verbose              (-v) produce verbose output (disabled by default)

# the following settings are used for gpg:
# --symmetric            (-c) use symmetric cipher for encryption
# --cipher-algo AES256        use AES256 as cipher algorithm
# --batch                     non-interactive mode
# --passphrase                use password provided in backupbot.conf
# --output               (-o) write output to file

# the following settings are used for mysqldump
# --single-transaction        dumps all tables in a single transaction

feature_files() {
    if [ "${BACKUP_FILES_ENABLE}" = 'YES' ]; then
        # change file name depending on whether its a manual, daily or weekly backup
        if [ "${ARGUMENT_DAILY}" = '0' ] && [ "${ARGUMENT_WEEKLY}" = '0' ]; then
            BACKUP_FILES_SUFFIX='files'
        elif [ "${ARGUMENT_DAILY}" = '1' ] && [ "${ARGUMENT_WEEKLY}" = '0' ]; then
            BACKUP_FILES_SUFFIX='daily-files'
        elif [ "${ARGUMENT_DAILY}" = '0' ] && [ "${ARGUMENT_WEEKLY}" = '1' ]; then
            BACKUP_FILES_SUFFIX='weekly-files'
        fi

        # check configured backup compression and create variables for arguments and file extension
        if [ "${BACKUP_FILES_COMPRESSION}" = '0' ]; then
            TAR_COMPRESSION_ARGUMENT=''
            BACKUP_FILES_EXTENSION='tar'
        elif [ "${BACKUP_FILES_COMPRESSION}" = '1' ]; then
            TAR_COMPRESSION_ARGUMENT='--gzip'
            BACKUP_FILES_EXTENSION='tar.gz'
        elif [ "${BACKUP_FILES_COMPRESSION}" = '2' ]; then
            TAR_COMPRESSION_ARGUMENT='--bzip2'
            BACKUP_FILES_EXTENSION='tar.bz2'
        elif [ "${BACKUP_FILES_COMPRESSION}" = '3' ]; then
            TAR_COMPRESSION_ARGUMENT='--xz'
            BACKUP_FILES_EXTENSION='tar.xz'
        fi

        # check whether backup encryption is enabled
        if [ "${BACKUP_ENCRYPTION_ENABLE}" = 'YES' ]; then
            requirement_gpg
            tar --create --preserve-permissions ${TAR_COMPRESSION_ARGUMENT} --file - ${BACKUP_FILES} | gpg --symmetric --cipher-algo AES256 --batch --passphrase "${BACKUP_ENCRYPTION_SECRET}" > "${BACKUP_FILES_DESTINATION}/${BACKUP_FILES_PREFIX}-${BACKUP_FILES_SUFFIX}.${BACKUP_FILES_EXTENSION}.gpg"
        else
            tar --create --preserve-permissions ${TAR_COMPRESSION_ARGUMENT} --file "${BACKUP_FILES_DESTINATION}/${BACKUP_FILES_PREFIX}-${BACKUP_FILES_SUFFIX}.${BACKUP_FILES_EXTENSION}" ${BACKUP_FILES}
        fi

        # delete backups older than file retention, unless it's zero (infinite)
        if [ "${BACKUP_FILES_RETENTION_DAILY}" -gt '0' ]; then
            find "${BACKUP_FILES_DESTINATION}/" -type f -mtime +"${BACKUP_FILES_RETENTION_DAILY}" -name '*-daily-files*' -delete
        fi
        if [ "${BACKUP_FILES_RETENTION_WEEKLY}" -gt '0' ]; then
            find "${BACKUP_FILES_DESTINATION}/" -type f -mtime +"${BACKUP_FILES_RETENTION_WEEKLY}" -name '*-weekly-files*' -delete
        fi
    fi
}

feature_mysql() {
    if [ "${BACKUP_MYSQL_ENABLE}" = 'YES' ]; then
        # change file name depending on whether its a manual, daily or weekly backup
        if [ "${ARGUMENT_DAILY}" = '0' ] && [ "${ARGUMENT_WEEKLY}" = '0' ]; then
            BACKUP_MYSQL_SUFFIX='mysql'
        elif [ "${ARGUMENT_DAILY}" = '1' ] && [ "${ARGUMENT_WEEKLY}" = '0' ]; then
            BACKUP_MYSQL_SUFFIX='daily-mysql'
        elif [ "${ARGUMENT_DAILY}" = '0' ] && [ "${ARGUMENT_WEEKLY}" = '1' ]; then
            BACKUP_MYSQL_SUFFIX='weekly-mysql'
        fi

        # check configured backup compression and create variables for arguments and file extension
        if [ "${BACKUP_MYSQL_COMPRESSION}" = '0' ]; then
            MYSQL_COMPRESSION_ARGUMENT='cat'
            BACKUP_MYSQL_EXTENSION='sql'
        elif [ "${BACKUP_MYSQL_COMPRESSION}" = '1' ]; then
            MYSQL_COMPRESSION_ARGUMENT='gzip'
            BACKUP_MYSQL_EXTENSION='sql.gz'
        elif [ "${BACKUP_MYSQL_COMPRESSION}" = '2' ]; then
            MYSQL_COMPRESSION_ARGUMENT='bzip2'
            BACKUP_MYSQL_EXTENSION='sql.bz2'
        elif [ "${BACKUP_MYSQL_COMPRESSION}" = '3' ]; then
            MYSQL_COMPRESSION_ARGUMENT='xz'
            BACKUP_MYSQL_EXTENSION='sql.xz'
        fi

        # check whether backup encryption is enabled
        if [ "${BACKUP_ENCRYPTION_ENABLE}" = 'YES' ]; then
            requirement_gpg
            # create a list of all user created mysql databases and mysqldump them to their own file
            for DB in $(mysql -e 'show databases' -s --skip-column-names | sed '/performance_schema/d' | sed '/information_schema/d' | sed '/mysql/d'); do
                mysqldump --single-transaction "${DB}" | ${MYSQL_COMPRESSION_ARGUMENT} | gpg --symmetric --cipher-algo AES256 --batch --passphrase "${BACKUP_ENCRYPTION_SECRET}" > "${BACKUP_MYSQL_DESTINATION}/${BACKUP_MYSQL_PREFIX}-${BACKUP_MYSQL_SUFFIX}-${DB}.${BACKUP_MYSQL_EXTENSION}.gpg"
            done
        else
            # create a list of all user created mysql databases and mysqldump them to their own file
            for DB in $(mysql -e 'show databases' -s --skip-column-names | sed '/performance_schema/d' | sed '/information_schema/d' | sed '/mysql/d'); do
                mysqldump --single-transaction "${DB}" | ${MYSQL_COMPRESSION_ARGUMENT} > "${BACKUP_MYSQL_DESTINATION}/${BACKUP_MYSQL_PREFIX}-${BACKUP_MYSQL_SUFFIX}-${DB}.${BACKUP_MYSQL_EXTENSION}"
            done
        fi

        # delete backups older than mysql retention, unless it's zero (infinite)
        if [ "${BACKUP_MYSQL_RETENTION_DAILY}" -gt '0' ]; then
            find "${BACKUP_MYSQL_DESTINATION}/" -type f -mtime +"${BACKUP_MYSQL_RETENTION_DAILY}" -name '*-daily-mysql*' -delete
        fi
        if [ "${BACKUP_MYSQL_RETENTION_WEEKLY}" -gt '0' ]; then
            find "${BACKUP_MYSQL_DESTINATION}/" -type f -mtime +"${BACKUP_MYSQL_RETENTION_WEEKLY}" -name '*-weekly-mysql*' -delete
        fi
    fi
}

################################################################################
# MAIN FUNCTION
################################################################################

backupbot_main() {
    # check whether requirements are met
    requirement_argument_validity

    # call option based on arguments
    if [ "${ARGUMENT_VERSION}" = '1' ]; then
        option_version
        exit 0
    elif [ "${ARGUMENT_HELP}" = '1' ]; then
        option_help
        exit 0
    elif [ "${ARGUMENT_CRON}" = '1' ]; then
        requirement_root
        requirement_os
        option_cron
        exit 0
    # call feature based on arguments
    elif [ "${ARGUMENT_BACKUP}" = '1' ]; then
        requirement_root
        requirement_os
        requirement_prevent_backup_overlap
        feature_files
        feature_mysql
        exit 0
    elif [ "${ARGUMENT_FILES}" = '1' ]; then
        requirement_root
        requirement_os
        feature_files
        exit 0
    elif [ "${ARGUMENT_MYSQL}" = '1' ]; then
        requirement_root
        requirement_os
        feature_mysql
        exit 0
    # return error on invalid argument
    elif [ "${ARGUMENT_NONE}" = '1' ]; then
        error_invalid_argument
    fi
}

# call main function
backupbot_main
